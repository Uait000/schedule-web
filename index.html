<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" type="image/svg+xml" href="/react.svg" />
    <link rel="icon" type="image/png" href="/icon-192x192.png" />
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¢–¢–ñ–¢</title>
    <meta name="description" content="–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –¢–¢–ñ–¢">
    
    <link rel="manifest" href="/manifest.json" crossorigin="use-credentials">
    
    <meta name="theme-color" content="#1976d2" />
    <meta name="msapplication-TileColor" content="#1976d2">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¢–¢–ñ–¢">
    
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.gstatic.com/s/materialicons/v140/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2" as="font" type="font/woff2" crossorigin="anonymous" onload="this.onload=null;this.rel='font-preload'">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons&display=block" rel="stylesheet" media="print" onload="this.media='all'">
    
    <link rel="preconnect" href="https://ttgt-api-isxb.onrender.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    
    <style>
      .install-prompt {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--color-surface, #ffffff);
        border: 2px solid var(--color-primary, #1976d2);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 320px;
        width: 90%;
        text-align: center;
        animation: slideUp 0.3s ease;
      }

      .install-prompt button {
        background: var(--color-primary, #1976d2);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 12px 20px;
        margin: 8px 4px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s ease;
      }

      .install-prompt button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
      }

      .install-prompt button.secondary {
        background: transparent;
        color: var(--color-text, #333333);
        border: 1px solid var(--color-border, #ddd);
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }

      .material-icons {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;
        line-height: 1;
        letter-spacing: normal;
        text-transform: none;
        display: inline-block;
        white-space: nowrap;
        word-wrap: normal;
        direction: ltr;
        -webkit-font-feature-settings: 'liga';
        -webkit-font-smoothing: antialiased;
      }

      .material-icons::before {
        content: '‚òÖ';
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        display: none;
      }

      .fonts-loaded .material-icons::before {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    
    <div id="install-prompt" class="install-prompt" style="display: none;">
      <div style="font-size: 48px; margin-bottom: 8px;">üì±</div>
      <p style="margin: 0 0 12px 0; font-weight: 600; font-size: 16px;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?</p>
      <p style="margin: 0 0 16px 0; font-size: 14px; color: var(--color-secondary-text, #666);">
        –ü–æ–ª—É—á–∏—Ç–µ –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é —Å –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
      </p>
      <button id="install-button">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <button id="cancel-install" class="secondary">–ü–æ–∑–∂–µ</button>
    </div>
    
    <script type="module" src="/src/main.tsx"></script>
    
    <script>
      // Font loading optimization
      function optimizeFontLoading() {
        if (document.fonts) {
          document.fonts.load('1em Material Icons').then(() => {
            document.documentElement.classList.add('fonts-loaded');
          }).catch(() => {
            console.log('Material Icons font load failed, using fallback');
          });
        }

        const preloadLink = document.querySelector('link[as="font"]');
        if (preloadLink) {
          setTimeout(() => {
            if (preloadLink.parentNode) {
              preloadLink.parentNode.removeChild(preloadLink);
            }
          }, 3000);
        }
      }

      class PWAInstaller {
        constructor() {
          this.deferredPrompt = null;
          this.installPrompt = document.getElementById('install-prompt');
          this.installButton = document.getElementById('install-button');
          this.cancelButton = document.getElementById('cancel-install');
          
          this.init();
        }
        
        init() {
          this.setupEventListeners();
          this.registerServiceWorker();
          this.checkPWAStatus();
        }

        checkPWAStatus() {
          const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
          const isIOSStandalone = navigator.standalone;
          
          if (isStandalone || isIOSStandalone) {
            console.log('üöÄ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –∫–∞–∫ PWA');
            document.documentElement.classList.add('pwa-mode');
          }
        }
        
        setupEventListeners() {
          window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üì≤ BeforeInstallPrompt event fired');
            e.preventDefault();
            this.deferredPrompt = e;
            
            setTimeout(() => {
              this.showInstallPrompt();
            }, 5000);
          });
          
          window.addEventListener('appinstalled', (e) => {
            console.log('‚úÖ PWA —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');
            this.hideInstallPrompt();
            this.deferredPrompt = null;
            localStorage.setItem('pwaInstalled', 'true');
          });
          
          this.installButton.addEventListener('click', () => {
            this.installPWA();
          });
          
          this.cancelButton.addEventListener('click', () => {
            this.hideInstallPrompt();
            localStorage.setItem('installPromptDismissed', Date.now().toString());
          });
        }
        
        showInstallPrompt() {
          if (localStorage.getItem('pwaInstalled') === 'true') return;
          
          const lastDismissed = localStorage.getItem('installPromptDismissed');
          if (lastDismissed) {
            const oneDay = 24 * 60 * 60 * 1000;
            if (Date.now() - parseInt(lastDismissed) < oneDay) return;
          }
          
          this.installPrompt.style.display = 'block';
        }
        
        hideInstallPrompt() {
          this.installPrompt.style.display = 'none';
        }
        
        async installPWA() {
          if (!this.deferredPrompt) {
            this.showFallbackInstructions();
            return;
          }
          
          this.deferredPrompt.prompt();
          const { outcome } = await this.deferredPrompt.userChoice;
          
          console.log('User response to install prompt:', outcome);
          
          if (outcome === 'accepted') {
            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω—è–ª —É—Å—Ç–∞–Ω–æ–≤–∫—É PWA');
          } else {
            console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª —É—Å—Ç–∞–Ω–æ–≤–∫—É PWA');
          }
          
          this.deferredPrompt = null;
          this.hideInstallPrompt();
        }
        
        showFallbackInstructions() {
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isAndroid = /Android/.test(navigator.userAgent);
          
          let message = '';
          
          if (isIOS) {
            message = '–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:\n\n1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" üì§\n2. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –º–µ–Ω—é –≤–Ω–∏–∑\n3. –í—ã–±–µ—Ä–∏—Ç–µ "–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª"\n4. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ';
          } else if (isAndroid) {
            message = '–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:\n\n1. –û—Ç–∫—Ä–æ–π—Ç–µ –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞ (—Ç—Ä–∏ —Ç–æ—á–∫–∏)\n2. –í—ã–±–µ—Ä–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω"\n3. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É';
          } else {
            message = '–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" –∏–ª–∏ "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω".';
          }
          
          alert(message);
        }
        
        registerServiceWorker() {
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
              .then((registration) => {
                console.log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
                
                registration.addEventListener('updatefound', () => {
                  const newWorker = registration.installing;
                  console.log('üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Service Worker');
                  
                  newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                      console.log('üÜï –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
                      if (confirm('–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û–±–Ω–æ–≤–∏—Ç—å?')) {
                        window.location.reload();
                      }
                    }
                  });
                });
              })
              .catch((error) => {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:', error);
              });
          }
        }
      }
      
      document.addEventListener('DOMContentLoaded', () => {
        optimizeFontLoading();
        new PWAInstaller();
      });

      window.addEventListener('load', () => {
        setTimeout(() => {
          document.documentElement.classList.add('fonts-loaded');
        }, 1000);
      });
    </script>
  </body>
</html>